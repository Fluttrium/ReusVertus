# Инструкция по тестированию

## 1. Подготовка окружения

### Переменные окружения (.env)

Создайте файл `.env` в корне проекта со следующими переменными:

```env
# База данных
DATABASE_URL="postgresql://user:password@host:5432/database?schema=reusvertus"

# ЮКасса (ОБЯЗАТЕЛЬНО для работы платежей)
# Получите в личном кабинете ЮКассы: https://yookassa.ru/my
YOOKASSA_SHOP_ID=342366
YOOKASSA_SECRET_KEY=your_secret_key
# Название магазина для страницы оплаты (опционально)
YOOKASSA_SHOP_NAME=RUES VERTES

# URL приложения (для редиректов после оплаты)
NEXT_PUBLIC_APP_URL=http://localhost:3000

# Email уведомления (опционально)
SMTP_USER=your_email@gmail.com
SMTP_PASS=your_app_password
ORDER_NOTIFICATION_EMAIL=your_email@gmail.com
```

#### Как получить ключи ЮКассы:

1. Зарегистрируйтесь в [ЮКассе](https://yookassa.ru/)
2. Перейдите в [личный кабинет](https://yookassa.ru/my)
3. Создайте магазин (если еще не создан)
4. Перейдите в раздел "Настройки" → "API"
5. Скопируйте:
   - **Shop ID** (идентификатор магазина) → `YOOKASSA_SHOP_ID`
   - **Секретный ключ** → `YOOKASSA_SECRET_KEY`

**Важно:**
- Для тестирования используйте **тестовые ключи** (в тестовом режиме)
- Для продакшена используйте **боевые ключи** (после подключения)
- Никогда не коммитьте ключи в git (они уже в `.gitignore`)

### Установка зависимостей

```bash
npm install
```

### Генерация Prisma Client

```bash
npx prisma generate
```

### Применение миграций базы данных

```bash
npx prisma migrate deploy
# или для разработки:
npx prisma db push
```

### Заполнение тестовыми данными (опционально)

```bash
npm run db:seed
```

## 2. Запуск проекта

```bash
npm run dev
```

Откройте [http://localhost:3000](http://localhost:3000)

## 3. Сценарии тестирования

### Сценарий 1: Регистрация и авторизация

1. Перейдите на главную страницу
2. Нажмите "Войти" или "Регистрация"
3. Зарегистрируйте нового пользователя:
   - Email: `test@example.com`
   - Пароль: `test123456`
   - Имя (опционально)
4. Войдите с созданными данными
5. Проверьте, что вы авторизованы (должна появиться иконка профиля)

**Ожидаемый результат:** Пользователь успешно зарегистрирован и авторизован

### Сценарий 2: Просмотр товаров

1. На главной странице просмотрите товары
2. Перейдите на страницу товара, кликнув на карточку
3. Проверьте отображение:
   - Изображение товара
   - Название и описание
   - Цена
   - Выбор размера, цвета (если доступно)
   - Кнопка "Добавить в корзину"

**Ожидаемый результат:** Товары отображаются корректно, можно выбрать параметры

### Сценарий 3: Добавление в корзину

1. На странице товара выберите размер/цвет (если нужно)
2. Нажмите "Добавить в корзину"
3. Перейдите в корзину (иконка корзины в шапке)
4. Проверьте:
   - Товар отображается в корзине
   - Правильная цена и количество
   - Можно удалить товар

**Ожидаемый результат:** Товар добавлен в корзину и отображается корректно

### Сценарий 4: Оформление заказа (без реальной оплаты)

1. В корзине заполните форму:
   - Адрес доставки: `г. Москва, ул. Тестовая, д. 1`
   - Телефон: `+7 (999) 123-45-67`
   - Email: `test@example.com`
2. Нажмите "Перейти к оплате"
3. **Важно:** Если ЮКасса не настроена, будет ошибка

**Ожидаемый результат:** 
- Создается заказ в БД со статусом `awaiting_payment`
- Создается платеж в ЮКассе
- Происходит редирект на страницу оплаты ЮКассы

### Сценарий 5: Тестирование оплаты (с тестовыми данными ЮКассы)

**Для тестирования используйте тестовые карты ЮКассы:**

1. После нажатия "Перейти к оплате" вы попадете на страницу ЮКассы
2. Используйте тестовую карту:
   - Номер: `5555 5555 5555 4444`
   - Срок: любая будущая дата (например, `12/25`)
   - CVC: любые 3 цифры (например, `123`)
3. Завершите оплату
4. Вы будете перенаправлены на `/payment/success?orderId=...`

**Ожидаемый результат:**
- Статус платежа проверяется автоматически
- Отображается страница успешной оплаты
- Есть ссылка "Посмотреть заказ"

### Сценарий 6: Просмотр заказа

1. После успешной оплаты нажмите "Посмотреть заказ"
2. Или перейдите в профиль → "Мои заказы"
3. Проверьте отображение:
   - Номер заказа
   - Статус заказа (должен быть "Оплачен")
   - Список товаров
   - Адрес доставки
   - Итоговая сумма

**Ожидаемый результат:** Заказ отображается со всеми деталями

### Сценарий 7: Проверка webhook ЮКассы

**Для тестирования webhook локально используйте ngrok или аналогичный сервис:**

1. Установите ngrok: `npm install -g ngrok`
2. Запустите туннель: `ngrok http 3000`
3. Скопируйте HTTPS URL (например, `https://abc123.ngrok.io`)
4. В настройках ЮКассы добавьте webhook URL: `https://abc123.ngrok.io/api/payments/webhook`
5. Создайте тестовый заказ и оплатите его
6. Проверьте логи сервера - должен прийти webhook от ЮКассы

**Ожидаемый результат:**
- Webhook получает уведомление от ЮКассы
- Статус заказа обновляется в БД
- Корзина очищается после успешной оплаты

## 4. Проверка базы данных

### Просмотр данных через Prisma Studio

```bash
npx prisma studio
```

Откроется веб-интерфейс на [http://localhost:5555](http://localhost:5555)

Проверьте:
- Таблица `User` - созданные пользователи
- Таблица `Product` - товары
- Таблица `CartItem` - товары в корзинах
- Таблица `Order` - созданные заказы с `paymentId` и `paymentStatus`
- Таблица `OrderItem` - товары в заказах

## 5. Тестирование API endpoints

### Регистрация пользователя

```bash
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "test123456",
    "name": "Test User"
  }'
```

### Получение товаров

```bash
curl http://localhost:3000/api/products
```

### Добавление в корзину (требует авторизации)

```bash
curl -X POST http://localhost:3000/api/cart \
  -H "Content-Type: application/json" \
  -H "x-user-id: USER_ID" \
  -d '{
    "productId": "PRODUCT_ID",
    "quantity": 1,
    "size": "M",
    "color": "black"
  }'
```

### Создание платежа (требует авторизации)

```bash
curl -X POST http://localhost:3000/api/payments/create \
  -H "Content-Type: application/json" \
  -H "x-user-id: USER_ID" \
  -d '{
    "address": "г. Москва, ул. Тестовая, д. 1",
    "phone": "+79991234567",
    "email": "test@example.com"
  }'
```

## 6. Частые проблемы и решения

### Проблема: "Платежная система не настроена"

**Решение:** Проверьте наличие переменных `YOOKASSA_SHOP_ID` и `YOOKASSA_SECRET_KEY` в `.env`

### Проблема: "Database connection error"

**Решение:** 
- Проверьте `DATABASE_URL` в `.env`
- Убедитесь, что база данных доступна
- Выполните `npx prisma migrate deploy`

### Проблема: "Prisma Client не инициализирован"

**Решение:** Выполните `npx prisma generate`

### Проблема: Webhook не работает локально

**Решение:** Используйте ngrok или другой туннель для локальной разработки

## 7. Чек-лист тестирования

- [ ] Регистрация нового пользователя
- [ ] Авторизация существующего пользователя
- [ ] Просмотр списка товаров
- [ ] Просмотр страницы товара
- [ ] Добавление товара в корзину
- [ ] Удаление товара из корзины
- [ ] Оформление заказа
- [ ] Создание платежа в ЮКассе
- [ ] Оплата тестовой картой
- [ ] Проверка статуса заказа после оплаты
- [ ] Просмотр заказа в профиле
- [ ] Получение webhook от ЮКассы (если настроен)

## 8. Тестовые данные ЮКассы

Для тестирования используйте:
- **Тестовый магазин:** Создайте в личном кабинете ЮКассы
- **Тестовые карты:**
  - Успешная оплата: `5555 5555 5555 4444`
  - Отклоненная: `5555 5555 5555 4477`
  - 3D Secure: `5555 5555 5555 4477` (потребует подтверждения)

## 9. Мониторинг логов

Следите за логами в консоли сервера:
- Создание заказов
- Создание платежей
- Получение webhook от ЮКассы
- Ошибки базы данных
